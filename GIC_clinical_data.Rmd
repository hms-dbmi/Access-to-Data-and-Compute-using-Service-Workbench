---
title: "GIC_clinical_data"
output:
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE)

memory.limit(size = 16000)


```


#### Installing the relevant Rstudio packages and loading the clinical dataset
remove the hashtag before the "installing.packages" prior to running the code, there is only need to install them once.
```{r 1, paged.print=TRUE}

#install.packages(tidyverse)
#install.packages(lubridate)
#install.packages(readr)

library(tidyverse)
library(lubridate)
library(readr)


```

### Instructions for Accessing and Loading Patient-Level Data Files

#### Step 1: Define the File Path

To access patient-level data, define a variable for the file path where the data is stored. The file path format is as follows:

data <- '/home/[environment-type]/studies/[study-folder]/[filename]'


**Environment-type:**
- If you are using an RStudio workspace, use `'rstudio-user'` for the `[environment-type]`.
- If you are using a Sagemaker, Linux, or Windows workspace, use `'ec2-user'` for the `[environment-type]`.

**Study Folder:**
- This is the name of the study where the patient-level data is stored for your project.

**File Name:**
- This is the name of the file you want to access within the study folder.

#### Example:
As a researcher using an RStudio workspace to access clinical data for your project, you would set up the file paths like this:

- **Study Folder:** `GIC_training_dataset`
- **Clinical Data File:** `synthea_10k_picsure_format.csv` (in CSV format)


```r
# File paths
clinical_data <- '/home/rstudio-user/studies/GIC_training_dataset/synthea_10k_picsure_format.csv'

```

#### Step 2: Read the CSV Files
Load the clinical data from the CSV file into R data frames by using the read.csv function.

```{r}
#load data set:

clinical_data<- read_csv("~/home/rstudio-user/studies/GIC_training_dataset/synthea_10k_picsure_format.csv")


# change time stamp to numeric value of the date and renaming PATIENT_NUM column to patient id
gic_data <- clinical_data %>%
 mutate(TIMESTAMP = as_date(ymd_hms(TIMESTAMP))) %>%
  rename(patient_id = PATIENT_NUM)
```

***The dataset used in this demonstration includes 10,000 synthetic patient records which were generated using the Synthea Patient Generator. It includes all age groups and is not limited to pediatric patients***


#### Working with patient demographics from the dataset
Here we will explore, organize and visualize the demographic data available in our dataset. This includes age, sex and race.

```{r}
# Create a new dataframe including only the demographics data:

demographics<- gic_data %>%
  filter(grepl("\\ACT Demographics", CONCEPT_PATH))

```

Creating a table of patient ids we might use later on:

```{r}

# creating a dataframe of patient ids included in the dataset
patient_ids<- demographics %>%
  select(patient_id) %>%
  distinct()

```

##### Sex data:

Organizing the data:
```{r}
# isolating and showing sex data:

demographics_sex <- demographics %>%
  filter(grepl("Sex", CONCEPT_PATH)) %>%
  select(patient_id, TVAL_CHAR)

# renaming the column title to "sex":
demographics_sex<- demographics_sex %>%
  rename(sex=TVAL_CHAR)

head(demographics_sex)

```

Creating a table to show the sex distribution of the dataset:
```{r}
# grouping by sex and calculating the percentage of each:
sex_count<- demographics_sex %>%
  group_by(sex) %>%
  summarise(count=n()) %>%
  mutate(percentage = (count / sum(count)) * 100)

sex_count
```

##### Age data:

Organizing the data:
```{r}
# isolating and showing age data + renaming column title to "age":
demographics_age<- demographics %>%
   filter(grepl("Age", CONCEPT_PATH)) %>%
  select(patient_id, NVAL_NUM) %>%
  rename(age=NVAL_NUM) %>%
  arrange(patient_id)
```

Plotting the age distribution in the dataset: 
```{r}
#Creating a histogram, demonstrating the age distribution:

ggplot(data = demographics_age) +
  geom_histogram(aes(x=age), binwidth = 1, fill = "blue", color = "black") +
  theme_bw() +
  scale_x_continuous(n.breaks=18)+
  labs(x = "Age", y = "Frequency", title = "Age Distribution")


```

creating a table of patients age group distribution (18, 18-65, 65+)
```{r}
# grouping by age (<18 , 18-65, 65+)

age_groups<- demographics_age %>%
  mutate(age_group= case_when(age < 18 ~ "<18",
                    age >= 18 & age <65 ~ "18-65",
                   age >=65 ~ "65+"))

# calculating number of patients in each group

age_group_sum<- age_groups %>%
  group_by(age_group)%>%
  summarize(count=n()) %>%
  arrange(factor(age_group, levels = c("<18", "18-65", "65+")))

age_group_sum
```

##### Race data:
Organizing the data: 
```{r}
# isolating race data + renaming column title to "race":
demographics_race<- demographics %>%
  filter(grepl("Race", CONCEPT_PATH)) %>%
   select(patient_id, TVAL_CHAR)%>%
  rename(race=TVAL_CHAR)

```

creating a table of the race distribution
```{r}

# grouping by race and calculating the percentage of each:

race_count <- demographics_race %>%
  group_by(race) %>%
  summarise(count = n()) %>%
  mutate(percentage = round((count / sum(count)) * 100,2)) %>%
  mutate(race = fct_reorder(race, -percentage)) %>%
  arrange(-percentage)

race_count

```

creating a graphic representation of race distribution: 
```{r}
# create a bar plot representing race distribution:

ggplot(data= race_count) +
  geom_bar(aes(x=race, y=percentage, fill= race ), stat = "identity")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(legend.position = "none")+
  labs(x="Race",y="Percentage", title="Participants Race Distribution") 
```

##### Merging demographic data

creating one table presenting all the demographic data by patient id (age, sex, race)
```{r}
#merging all columns to show age, sex, race in one table:

demographics_joined<- demographics_age %>%
  left_join(demographics_sex, by="patient_id") %>%
  left_join(demographics_race, by= "patient_id")

head(demographics_joined)
```


### Diagnosis

##### Here we will look for specific patient diagnostic cohorts and then cross data with their demographic data, as well as other diagnostic codes. 

```{r}
#create a new data frame including only diagnosis data:

diagnosis_icd10 <- gic_data %>%
  filter(grepl("\\ACT Diagnosis ICD-10", CONCEPT_PATH))
```


##### Looking at a group of diagnosis: creating a cohort of patients with a certain disease or group of diseases by using ICD codes. In this example the disease of interest is epilepsy, we will be using ICD group code "G40", which includes the following and their sub-groups:
- G40.0: Localization-related (focal) (partial) idiopathic epilepsy and epileptic syndromes with seizures of localized onset.
- G40.1: Localization-related (focal) (partial) symptomatic epilepsy and epileptic syndromes with simple partial seizures.
- G40.2: Localization-related (focal) (partial) symptomatic epilepsy and epileptic syndromes with complex partial seizures.
- G40.3: Generalized idiopathic epilepsy and epileptic syndromes
- G40.A: Absence epileptic syndrome.
- G40.B: Juvenile myoclonic epilepsy [impulsive petit mal].
- G40.C: Lafora progressive myoclonus epilepsy, intractable.
- G40.4: Other generalized epilepsy and epileptic syndromes.
- G40.5: Epileptic seizures related to external causes.
- G40.8: Other epilepsy and recurrent seizures.
- G40.9: Epilepsy, unspecified.

##### A full list of ICD-10 codes can be found at  ("https://www.icd10data.com/ICD10CM/Codes")

creating a new data-frame that only includes patients with epilepsy and then creating a seprate list of patient ids:
(you can replace the ICD code "G40" with the ICD code of your choice in the next chunk of code)
```{r}
#filtering to include only patients diagnosed with epilepsy and recurrent seizures (ICD GROUP CODE G40):

epilepsy_icd10<- diagnosis_icd10 %>%
  filter(grepl("G40", TVAL_CHAR)) %>%
  select(patient_id, CONCEPT_PATH,TVAL_CHAR) %>%
  rename(icd_10_code= TVAL_CHAR) %>%
  group_by(patient_id)

# creating a final list of patient_ids with epilepsy (G40 group code), removing any duplicate entries for same patient id :

epilepsy_icd10_patient_ids<- epilepsy_icd10 %>%
  select(patient_id) %>%
  distinct() 
```


```{r}


# calculating percentage of patients with epilepsy from original cohort:
percentage_epilepsy <-  (nrow(epilepsy_icd10_patient_ids) / nrow(patient_ids)) * 100

percentage_epilepsy

```

creating a dataframe with the epilepsy patient's demographic data
```{r}
# merging the patient id list with the demographic data
epi_demo<- epilepsy_icd10_patient_ids %>%
  left_join(demographics_joined, by= "patient_id") %>%
  arrange(patient_id)

head(epi_demo)
```


##### Cross-checking other diagnostic codes in defined patient cohort (Epilepsy)

This will be done in a few steps.
(you can replace the ICD code "G43" with the ICD code of your choice in the next chunk of code):
```{r}
##first, creating a data-frame including only patients diagnosed with migraines (ICD GROUP CODE G43)

migraine_icd10<- diagnosis_icd10 %>%
  filter(grepl("G43",TVAL_CHAR)) %>% 
  select(patient_id, CONCEPT_PATH,TVAL_CHAR) %>%
  rename(icd_10_code= TVAL_CHAR)%>%
  group_by(patient_id)

#next, extracting only the patient id's and removing any duplicates.
migraine_icd10_patient_ids<- migraine_icd10 %>%
  select(patient_id) %>%
  distinct()


#finally, merging the epilepsy patient id list with the migraine patient id list to create a list including only patients that have both epilepsy and migraine ICD10 codes 
epilepsy_migraine <- epilepsy_icd10_patient_ids %>%
  inner_join(migraine_icd10_patient_ids, by = "patient_id")
  

```

now, let's examine the original epilepsy dataframe and add a column indicating which patients also have migraines:
```{r}

# merging the joint list to the original epilepsy patient list, and creating a migraine column indicating if the patient with epilepsy also has a migraine diagnosis (yes=1/ no=0):

epilepsy_merged <- epilepsy_icd10_patient_ids %>%
  left_join(epilepsy_migraine %>% mutate(migraines = 1), by = "patient_id") %>%
  replace_na(list(migraines = 0))  %>%
  left_join(epi_demo, by="patient_id") %>%
  arrange(patient_id)

head(epilepsy_merged)
```

creating a table showing the percentage of patients with migraines in the epilepsy patient cohort:
```{r}

#calculating the number and percentage of patient with migraines in the epilepsy patient cohort
epilepsy_migraine_count <- epilepsy_merged %>%
  group_by(migraines) %>%
  summarise(count=n()) %>%
  mutate(percentage = round((count / sum(count)) * 100,2)) 
 
epilepsy_migraine_count
```


#### Medication (administered medication)

##### Creating a list of medications from the original dataset
```{r}

#creating a new dataframe containing only medication data:

medications<- gic_data %>%
  filter(grepl("\\ACT Medications", CONCEPT_PATH)) 

#showing list with unique values of medications included in the dataset:

medication_list<- medications %>%  
  select(CONCEPT_PATH)%>%
  distinct() %>%
  arrange(CONCEPT_PATH)

medication_list
```

##### Looking at selected medication administration in the original dataset

here we have chosen Carbamazepine and Pregabalin. You can change to any other medication included in the medication list.
```{r}

#filtering original dataset to patients receiving Carbamazepine or/and Pregabalin

carba_preg<- medications %>%
  filter(grepl("Carbamazepine",CONCEPT_PATH) |
         grepl("Pregabalin", CONCEPT_PATH)) %>%
  select(patient_id,CONCEPT_PATH)

#creating a new column indicating if a patient has been prescribed Carbamazepine or Pregabalin (yes=1,no=0) for easier visualization and data manipulation
cleaned_medication <- carba_preg %>%
  mutate(carbamazepine= if_else(grepl("Carbamazepine", CONCEPT_PATH) , 1,0),
         pregabalin=if_else(grepl("Pregabalin", CONCEPT_PATH) , 1,0) ) %>%
  group_by(patient_id) %>%
  summarize(
    carbamazepine = max(carbamazepine),
    pregabalin = max(pregabalin)
  ) %>%
  arrange(patient_id)

head(cleaned_medication)

```

##### Looking at the selected medication in the specific patient cohort we formerly created (Epilepsy)
```{r}

#merging the patient id list of epilepsy patients with the patient medication data frame, filing missing entries with "0"(=no/ no information included in dataset):

patient_icd10_med <- epilepsy_icd10_patient_ids %>% 
  left_join(cleaned_medication, by="patient_id") %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
  arrange(patient_id)

head(patient_icd10_med)

```

#### Lab Results
exploring lab results and different graphic representations of the data

##### Creating a list of lab tests available in dataset:
```{r}

# Creating a new dataframe containing only the lab test results for all patients in the original dataset:
lab_test_results<- gic_data %>%
   filter(grepl("\\ACT Lab Test Results",CONCEPT_PATH)) 

# creating a list with unique types of lab tests included in the dataset:
lab_list<- gic_data %>%
   filter(grepl("\\ACT Lab Test Results",CONCEPT_PATH)) %>%
  select(CONCEPT_PATH)%>%
  distinct()

lab_list

```


##### Looking at specific lab test results wihthin a defined time frame:
**DISCLAIMER: The number of lab result entries can vary widely per patient, and even multiple entries per day are possible. In the graphic representation and statistical measurement tables, each individual lab result is treated as an individual data point, without the use of weighted averages or other methodological statistical adjustments.
(you can replace "ALT" or "AST" with your choice of lab test, to add additional lab tests just add a "|" before the next lab test name)

looking at LFTs results in 2023 and creating a statistical measurement table:
```{r}
#filtering the original dataset to include only AST and ALT test results from the year 2023, cleaning the data, and organizing it by patient id:

alt_ast<- lab_test_results %>%
  filter(grepl("ALT|AST",CONCEPT_PATH),
         TIMESTAMP >= as.Date("2023-01-01") & TIMESTAMP <= as.Date("2023-12-31")) %>%
  mutate(lab_test =case_when(grepl("AST", CONCEPT_PATH) ~ "ast",
                              grepl("ALT", CONCEPT_PATH) ~ "alt")) %>%
  rename(value=NVAL_NUM) %>%
  select(patient_id, lab_test, value, TIMESTAMP) %>%
 arrange(patient_id, TIMESTAMP) %>%
  distinct()
  

#creating a table with statistic summary values 
alt_ast_sum<- alt_ast %>%
  group_by(lab_test) %>%
  summarise(mean=mean(value),
            sd= sd(value),
            n=n()) %>%
  mutate( se = sd / sqrt(n),
          lower_ci= mean - 1.96*se ,
          upper_ci= mean +1.96*se)

alt_ast_sum
```

##### Graphing results:
```{r}

#creating a box plot graph of the results. 

ggplot(data=alt_ast)+
  geom_boxplot(aes(x=lab_test, y=value, fill= lab_test))+
  theme_bw()+
  labs(x= "Lab Test", y= "Value (u/l)", title= "Liver Transaminase Levels in 2023, n=#", fill= " ")


```


##### Looking at an individual patient's lab results over time:
Looking at patient id # 03c3d97e-febe-7038-bcb7-961fc962ecba
we will look at the LFT trends over the year 2023
```{r}
#filtering for the specific patient's AST and ALT levels over time using the 2023 alt/ast dataframe we previously created: 

patient_group<- alt_ast %>% 
  filter(grepl("03c3d97e-febe-7038-bcb7-961fc962ecba", patient_id))

### creating a plot showing the results over time: 

ggplot(data = patient_group) +
  geom_line( aes(x = TIMESTAMP, y = value, color = lab_test)) +
  geom_point( aes(x = TIMESTAMP, y = value, color = lab_test)) +
  theme_bw() +
  theme(
    legend.position = "bottom",  
    axis.text.x = element_text(angle = 45, hjust = 1) 
  )+
    labs(x = "Date", y = "U/L", title = " Liver transaminase levels over time for patient '#', since event 'X' at 1.1.2023", color =" ")+
  guides(color = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5))
  


```


#### Procedures
exploring the procedures in the data set and looking at specific procedures of interest in a given time frame

##### creating a procedure list available in the dataset : 
```{r}

# creating a list with unique procedures in the dataset : 

procedures <- gic_data %>%
  filter(grepl("\\\\ACT Procedures", CONCEPT_PATH)) %>%
  distinct(CONCEPT_PATH, TVAL_CHAR) %>%
  rename(procedure=TVAL_CHAR)
```

##### selecting a specific procedure and timeframe
looking at patients who have undergone an appendectomy since the beginning of 2020
```{r}
# filtering to create a new dataframe including patients with a history of an appendectomy procedure

appendectomy<- gic_data %>%
  filter(grepl("Appendectomy", TVAL_CHAR)) %>%
  rename(procedure=TVAL_CHAR) %>%
  select(-CONCEPT_PATH, -NVAL_NUM) %>%
  distinct()

# filtering to only include patients who underwent an appendectomy since the beginning of the year 2020

appendectomy_2020<- appendectomy %>%
  filter(TIMESTAMP >= as.Date("2020-01-01")) %>%
  arrange(patient_id)

head(appendectomy_2020)
```

